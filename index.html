<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Respatory AR Simulation</title>
    <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>
    <!-- Load A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
      <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.0/dist/aframe-extras.min.js"></script>

</head>
<body>

<a-scene
  arjs
  embedded
  renderer="logarithmicDepthBuffer: true; "

  vr-mode-ui="enabled: false"
  gesture-detector
  id="scene"
>
  <a-assets>
    <a-asset-item
      id="resperatory-glb-model"
      src="./models/particles.glb"
      response-type="arraybuffer"
    >
    </a-asset-item>
  </a-assets>

      <a-marker rotatescale id="resperatory-glb-model-marker" type="pattern" url="./marker/pattern-lung_copilot_marker.patt">
      <a-entity
        id="resperatory-glb-model-child-entity"
        animation-mixer="loop: repeat; timeScale: 1"
        gltf-model="#resperatory-glb-model"
        scale="0.25 0.25 0.25"
      position="0 0 0"
      rotation="-90 0 0">

    </a-entity>
  </a-marker>

  <a-entity camera></a-entity>
        <a-entity
      light="type: point; intensity: 2; decay: 2"
      position="0 0 0">
    </a-entity>
</a-scene>

<script>
AFRAME.registerComponent("rotatescale", {
    init: function() {
        let element = document.querySelector('body');
        let hammerEl = new Hammer(element);

        this.marker = document.querySelector('a-marker'); // Component rotatescale needs to be applied on the a-marker tag
        let model = this.marker.querySelector('a-entity');

        let pinch = new Hammer.Pinch(); // Pinch is not by default in the recognizers
        hammerEl.add(pinch); // Add it to the Manager instance
                // create a pinch and rotate recognizer
        // these require 2 pointers
          var pan = new Hammer.Pan();

        // we want to detect both the same time
        pinch.recognizeWith(pan);

        // add to the Manager
        hammerEl.add([pinch, pan]);

             let initialScale = { x: 1, y: 1, z: 1 }; // default
        hammerEl.on("pinchstart", () => {
            // Store the current scale when pinch starts
            const currentScale = model.getAttribute("scale");
            initialScale = { ...currentScale };
        });

        hammerEl.on('pan', (ev) => {
            let rotation = model.getAttribute("rotation");
            switch(ev.direction) {
                case 2: // DIRECTION_LEFT from https://hammerjs.github.io/api/
                    rotation.y = rotation.y - 2;
                    break;
                case 4: // DIRECTION_RIGHT from https://hammerjs.github.io/api/
                    rotation.y = rotation.y + 2;
                    break;
                case 8: // DIRECTION_UP from https://hammerjs.github.io/api/
                    rotation.x = rotation.x - 2;
                    break;
                case 16: // DIRECTION_DOWN from https://hammerjs.github.io/api/
                    rotation.x = rotation.x + 2;
                    break;
                default:
                    break;
            }
            model.setAttribute("rotation", rotation);
        });

   hammerEl.on("pinch", (ev) => {
            // Apply scale relative to initial scale
            let newScale = {
                x: initialScale.x * ev.scale,
                y: initialScale.y * ev.scale,
                z: initialScale.z * ev.scale,
            };
            model.setAttribute("scale", newScale);
        });
    }
});
</script>
</body>
</html>
